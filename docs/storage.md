# Storage Organization

The storage for a taskhub has several components:

- *Persistent Message Queues*, stored in Event Hubs.
- 1-32 *Netherite Partitions*, stored in an Azure Blob Container.

The number of Netherite partitions is determined by the `PartitionCount` property in the [settings](settings.md), which defaults to 12.

## Event Hubs

Inside the event hubs namespace, the following event hubs are automatically created the first time it a taskhub is created:

* **An event hub called `partitions`** with 1-32 partitions.

  These are used to deliver messages to the Netherite partitions, reliably and in order. There is a one-to-one correspondence between the partitions of this event hub and the Netherite partitions. 

* **Four event hubs called `clients0`, `clients1`, `clients2` and `clients3`** with 32 partitions each.

  These are used for sending responses back to clients. By design, we use vastly more partitions (128) than the expected number of clients.
  The reason is that clients hash to these partitions randomly, and we want reduce the likelihood of hash conflicts.


Note that EventHubs accumulate charges for the reserved capacity measured in throughput units, or TU. In particular, the number of partitions, or the amount of data stored in them, does not matter.

## Azure Storage

In Azure Storage, a **\<taskhubname>-storage** container is created the first time a taskhub is used.
It contains the following folders and files:

|Name|Type|Content|
|-|-|-|
|$Default|folder|consumption checkpoint positions used by EventHubs|
|p00|folder|the state of partition 0|
|p01|folder|the state of partition 1|
|...|...|...|
|p11|folder|the state of partition 11|
|taskhubparameters.json|file|parameters of this taskhub|

You can delete a TaskHub manually by deleting this container, or its contents. A new taskhub will be created if you run the application again with the same taskhub name.

Additionally, option `TraceToBlob` is set to true in the [settings](settings.md), a **logs** container is automatically created. It contains append blobs that capture traces generated by each node. A new blob is started everytime a node (re)starts.

## Using Multiple TaskHubs

You can reuse an EventHubs namespace for TaskHubs, as long as you don't use it for multiple taskhubs *at the same time*.

In particular, it is not necessary to clear the content of the Event Hubs in between runs: any time a new TaskHub is created, it starts consuming and producing messages relative to the current latest position of the partitions. These initial positions are also recorded in the `taskhub.json` file.
